//----------------------------------------------------------
// Copyright (C) Microsoft Corporation. All rights reserved.
//----------------------------------------------------------
// MicrosoftAjaxAdoNet.js
Type.registerNamespace("Sys.Data");Sys.Data.AdoNetQueryBuilder=function(a){this._queryParameters={};this._uri=a;var b=a.indexOf("?");if(b>=0){this._uri=a.substr(0,b);var d=a.substr(b+1).split("&");for(var e in d){param=d[e];var c=param.indexOf("=");if(c>=0)this._queryParameters[param.substr(0,c)]=param.substr(c+1);else this._queryParameters[param]=""}}};Sys.Data.AdoNetQueryBuilder.prototype={_queryParameters:null,_uri:null,get_skip:function(){return this._getIntParam("$skip")},set_skip:function(a){this._setParam("$skip",a)},get_top:function(){return this._getIntParam("$top")},set_top:function(a){this._setParam("$top",a)},get_orderby:function(){return this._getStringParam("$orderby")},set_orderby:function(a){this._setParam("$orderby",a)},get_filter:function(){return this._getStringParam("$filter")},set_filter:function(a){this._setParam("$filter",a)},get_expand:function(){return this._getStringParam("$expand")},set_expand:function(a){this._setParam("$expand",a)},get_resourcePath:function(){return this._uri},get_queryParameters:function(){return this._queryParameters},toString:function(){var b=[];for(var a in this._queryParameters)if(!Array.contains(Sys.Data.AdoNetQueryBuilder._queryOptions,a)){var e=this._queryParameters[a];if(e!=null)Array.add(b,{key:a,value:e})}for(var d in Sys.Data.AdoNetQueryBuilder._queryOptions){var a=Sys.Data.AdoNetQueryBuilder._queryOptions[d],e=this._queryParameters[a];if(e!=null)Array.add(b,{key:a,value:e})}var c=new Sys.StringBuilder(this._uri),f=true;for(var d in b){c.append(f?"?":"&");c.append(b[d].key);c.append("=");c.append(b[d].value);f=false}return c.toString()},_getIntParam:function(b){var a=parseInt(this._queryParameters[b]);return isNaN(a)?null:a},_getStringParam:function(b){var a=this._queryParameters[b];return a||null},_setParam:function(b,a){if(a==null)delete this._queryParameters[b];else this._queryParameters[b]=a}};Sys.Data.AdoNetQueryBuilder._queryOptions=["$filter","$orderby","$skip","$top"];Sys.Data.AdoNetQueryBuilder.registerClass("Sys.Data.AdoNetQueryBuilder");Sys.Data._AdoNetUtil=function(){};Sys.Data._AdoNetUtil.concatUris=function(b,a){if(a.indexOf("//")>=0)return a;if(b.endsWith("/"))b=b.substr(0,b.length-1);if(a.startsWith("/"))a=a.substr(1);return b+"/"+a};Sys.Data._AdoNetUtil.extractETag=function(a){return a.__metadata?a.__metadata.etag||null:null};Sys.Data._AdoNetUtil.extractUri=function(a){return a.__metadata?a.__metadata.uri||null:null};Sys.Data._AdoNetUtil.registerClass("Sys.Data._AdoNetUtil");Sys.Data.AdoNetActionResult=function(c,d,a,b){this._result=c;this._error=d;this._actionContext=a;this._operation=b};Sys.Data.AdoNetActionResult.prototype={_actionContext:null,_error:null,_operation:null,_result:null,get_actionContext:function(){return this._actionContext},get_error:function(){return this._error},get_operation:function(){return this._operation},get_result:function(){return this._result}};Sys.Data.AdoNetActionResult.registerClass("Sys.Data.AdoNetActionResult");Sys.Data.AdoNetActionSequence=function(a){this._actionQueue=[];this._dataService=a};Sys.Data.AdoNetActionSequence.prototype={_actionQueue:null,_dataService:null,get_serviceProxy:function(){return this._dataService},addInsertAction:function(d,a,b){var c=this._dataService;Array.enqueue(this._actionQueue,function(e){c.insert(d,a,Sys.Data.AdoNetActionSequence._genSuccessCallback(e),Sys.Data.AdoNetActionSequence._genFailureCallback(e),b)})},addInvokeAction:function(b,e,d,a){var c=this._dataService;Array.enqueue(this._actionQueue,function(f){c.invoke(b,e,d,Sys.Data.AdoNetActionSequence._genSuccessCallback(f),Sys.Data.AdoNetActionSequence._genFailureCallback(f),a)})},addUpdateAction:function(c,a){var b=this._dataService;Array.enqueue(this._actionQueue,function(d){b.update(c,Sys.Data.AdoNetActionSequence._genSuccessCallback(d),Sys.Data.AdoNetActionSequence._genFailureCallback(d),a)})},addRemoveAction:function(c,a){var b=this._dataService;Array.enqueue(this._actionQueue,function(d){b.remove(c,Sys.Data.AdoNetActionSequence._genSuccessCallback(d),Sys.Data.AdoNetActionSequence._genFailureCallback(d),a)})},clearActions:function(){Array.clear(this._actionQueue)},execute:function(b,c){var a={actionResultQueue:[],hasError:false,remainingActions:this._actionQueue};this._actionQueue=[];Array.enqueue(a.remainingActions,function(a){if(b)window.setTimeout(function(){b(a.actionResultQueue,a.hasError,c)},0)});Array.dequeue(a.remainingActions)(a)}};Sys.Data.AdoNetActionSequence._genSuccessCallback=function(a){return function(d,b,c){var e=new Sys.Data.AdoNetActionResult(d,null,b,c);Array.enqueue(a.actionResultQueue,e);Array.dequeue(a.remainingActions)(a)}};Sys.Data.AdoNetActionSequence._genFailureCallback=function(a){return function(d,b,c){a.hasError=true;var e=new Sys.Data.AdoNetActionResult(null,d,b,c);Array.enqueue(a.actionResultQueue,e);Array.dequeue(a.remainingActions)(a)}};Sys.Data.AdoNetActionSequence.registerClass("Sys.Data.AdoNetActionSequence");Sys.Data.AdoNetInvokeParametersBuilder=function(){this._queryBuilder=new Sys.Data.AdoNetQueryBuilder("");this._parameters=this._queryBuilder.get_queryParameters()};Sys.Data.AdoNetInvokeParametersBuilder.prototype={_parameters:null,_queryBuilder:null,get_parameters:function(){return this._parameters},addBoolean:function(b,a){this._parameters[b]=a.toString()},addDate:function(d,a,b){var c=b?a.format("yyyy-MM-ddTHH:mm:ss.fffffffzzz"):a.format("yyyy-MM-ddTHH:mm:ss.fffffff");this._parameters[d]="datetime'"+c+"'"},addDecimal:function(b,a){this._parameters[b]=a.toString()+"M"},addDouble:function(b,a){this._parameters[b]=a.toString()},addGuid:function(b,a){this._parameters[b]="guid'"+a+"'"},addInteger:function(b,a){this._parameters[b]=a.toString()},addString:function(b,a){this._parameters[b]="'"+a.replace(new RegExp("'","g"),"''")+"'"},toString:function(){return this._queryBuilder.toString()}};Sys.Data.AdoNetInvokeParametersBuilder.registerClass("Sys.Data.AdoNetInvokeParametersBuilder");Sys.Data.AdoNetRes={"operationFailed":"The data operation '{0}' failed.","operationTimedOut":"The data operation '{0}' timed out.","serviceVersionTooHigh":"The URI '{0}' points to an ADO.NET Data Service of a higher version than is supported by this library.","uriNotAdoNetService":"The URI '{0}' does not point to an ADO.NET Data Service."};Sys.Data.AdoNetServiceError=function(a,b){this._timedOut=a;this._message=b};Sys.Data.AdoNetServiceError.prototype={_errorObject:null,_message:null,_statusCode:-1,_timedOut:false,get_errorObject:function(){return this._errorObject},get_message:function(){return this._message},get_statusCode:function(){return this._statusCode},get_timedOut:function(){return this._timedOut}};Sys.Data.AdoNetServiceError.registerClass("Sys.Data.AdoNetServiceError");Sys.Data.AdoNetServiceProxy=function(a){this._serviceUri=a};Sys.Data.AdoNetServiceProxy.prototype={_defaultFailedCallback:null,_defaultSucceededCallback:null,_defaultUserContext:null,_replaceOnUpdate:false,_serviceUri:null,_timeout:0,_usePostTunneling:true,get_defaultFailedCallback:function(){return this._defaultFailedCallback},set_defaultFailedCallback:function(a){this._defaultFailedCallback=a},get_defaultSucceededCallback:function(){return this._defaultSucceededCallback},set_defaultSucceededCallback:function(a){this._defaultSucceededCallback=a},get_defaultUserContext:function(){return this.defaultUserContext},set_defaultUserContext:function(a){this.defaultUserContext=a},get_replaceOnUpdate:function(){return this._replaceOnUpdate},set_replaceOnUpdate:function(a){this._replaceOnUpdate=a},get_serviceUri:function(){return this._serviceUri},get_timeout:function(){return this._timeout||Sys.Net.WebRequestManager.get_defaultTimeout()},set_timeout:function(a){this._timeout=a},createActionSequence:function(){return new Sys.Data.AdoNetActionSequence(this)},insert:function(g,d,b,c,e,f){var a=this._prepareWebRequest(g,d,"POST",b,c,e,"insert",f);a.invoke();return a},invoke:function(c,b,a,f,g,h,i){var e=new Sys.Data.AdoNetQueryBuilder(c);a=a||{};for(key in a)e.get_queryParameters()[encodeURIComponent(key)]=encodeURIComponent(a[key]);b=b||"GET";var d=this._prepareWebRequest(null,e.toString(),b,f,g,h,c,i);d.invoke();return d},populateDeferredProperty:function(a,b,e,g,h,i){var f=Function.createDelegate(this,function(g,f,d){a[b]=g;var c=e||this._defaultSucceededCallback;if(c)c(a,f,d)}),c;if(a[b]&&a[b].__deferred&&a[b].__deferred.uri)c=a[b].__deferred.uri;else if(a.__metadata&&a.__metadata.uri)c=a.__metadata.uri+"/"+b;var d=this._prepareWebRequest(null,c,"GET",f,g,h,b,i);d.invoke();return d},query:function(b,c,d,e,f){var a=this._prepareWebRequest(null,b,"GET",c,d,e,b,f);a.invoke();return a},update:function(f,b,c,d,e){var g=this._replaceOnUpdate?"PUT":"MERGE",a=this._prepareWebRequest(f,null,g,b,c,d,"update",e);a.invoke();return a},remove:function(f,b,c,d,e){var a=this._prepareWebRequest(f,null,"DELETE",b,c,d,"remove",e);a.set_body(null);delete a.get_headers()["Content-Type"];a.invoke();return a},_onResponseComplete:function(d,m,c,g,b){if(!d.get_responseAvailable()){var k=d.get_timedOut(),h=k?String.format(Sys.Data.AdoNetRes.operationTimedOut,b):String.format(Sys.Data.AdoNetRes.operationFailed,b);if(c){var e=new Sys.Data.AdoNetServiceError(k,h);c(e,g,b);return}}var a=d.get_statusCode();if(a==1223||a==0)a=204;var j=d.getResponseHeader("DataServiceVersion");if(!j.startsWith("1.0;")&&a!=204){var h=j.length>0?String.format(Sys.Data.AdoNetRes.serviceVersionTooHigh,this._serviceUri):String.format(Sys.Data.AdoNetRes.uriNotAdoNetService,this._serviceUri);if(c){var e=new Sys.Data.AdoNetServiceError(false,h);c(e,g,b);return}}var n=d.getResponseHeader("Content-Type"),f=null,l=null;if(n.startsWith("application/json")){var i=d.get_object();f=i.error;l=i.d}if(a<200||a>=300){var h=f?f.message.value:String.format(Sys.Data.AdoNetRes.operationFailed,b);if(c){var e=new Sys.Data.AdoNetServiceError(false,h);e._statusCode=a;e._errorObject=f;c(e,g,b)}}else if(m)m(l,g,b)},_prepareWebRequest:function(e,k,i,g,f,d,l,a){a=a||new Sys.Net.WebRequest;a.set_url(Sys.Data._AdoNetUtil.concatUris(this._serviceUri,k||""));a.set_timeout(this.get_timeout());var b=a.get_headers();b["Accept"]="application/json";b["DataServiceVersion"]="1.0;AspNetAjax";b["MaxDataServiceVersion"]="1.0;";a.set_httpVerb(i);if(this._usePostTunneling){var c=i.toUpperCase();if(c=="PUT"||c=="DELETE"||c=="MERGE"){a.set_httpVerb("POST");b["X-HTTP-Method"]=c}}if(e){a.set_body(Sys.Serialization.JavaScriptSerializer.serialize(e));b["Content-Type"]="application/json";var h=Sys.Data._AdoNetUtil.extractETag(e);if(h)b["If-Match"]=h;var j=Sys.Data._AdoNetUtil.extractUri(e);if(j)a.set_url(j)}g=g||this._defaultSucceededCallback;f=f||this._defaultFailedCallback;if(typeof d==="undefined"||d===null)d=this._defaultUserContext;a.add_completed(Function.createDelegate(this,function(a){this._onResponseComplete(a,g,f,d,l)}));return a}};Sys.Data.AdoNetServiceProxy.registerClass("Sys.Data.AdoNetServiceProxy");